<!DOCTYPE html>
<html>
<head>
  <title>Quizlam Basic Frontend</title>
</head>
<body>
  <h1>CI</h1>

  <input type="text" id="playerName" placeholder="Enter name" />
</br>
  <button onclick="createRoom()" id="createRoom">Create Room</button>
  <button onclick="joinRoom()">Join Room</button>

<input type="text" id="roomCode" placeholder="Enter room code" />

  <hr />
  <button onclick="selectQuestion()">Select Question</button></br>
  <button onclick="startGame()">Start Game</button>
  <button onclick="buzzIn()">Buzz In</button>


  <hr />

  <input type="number" id="pointsToAward" placeholder="Points" />
  <button onclick="awardPoints()">Award Points</button>

  <button onclick="simulateDisconnect()">Disconnect</button>

  <hr />

  <pre id="log"></pre>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io(); // connects to backend
    const creatRoombuttonId = document.getElementById('createRoom');

    let playerId = null;
    let roomCode = null;

    function log(msg) {
      const pre = document.getElementById('log');
      pre.textContent += msg + '\n';
      pre.scrollTop = pre.scrollHeight;
    }

    function validateName(name){
      if (!name || name.trim() === '') {
        log('âŒ Name cannot be empty');
        return false;
      }
      return true;
    }

    function createRoom() {
      const name = document.getElementById('playerName').value;

      if (!validateName(name)) return;
      log('Creating room, host: ' + name);
      
      socket.emit('createRoom', { playerName: name }, (res) => {
        log('Response: ' + JSON.stringify(res));
        if (res.error) return log('âŒ ' + res.error);
        playerId = res.player.id;
        roomCode = res.room.roomCode;
        document.getElementById('roomCode').value = roomCode;
        console.log('created: ' + roomCode + 'by' + playerId )
        creatRoombuttonId.disabled = true;
      });
    }

    function joinRoom() {
      const name = document.getElementById('playerName').value;
      const code = document.getElementById('roomCode').value;

      if (!validateName(name)) return;

      socket.emit('joinRoom', { roomCode: code, playerName: name }, (res) => {
        if (res.error) return log('âŒ ' + res.error);
        playerId = res.player.id;
        roomCode = res.room.roomCode;
        creatRoombuttonId.disabled = true;
        log('âœ… Joined room: ' + ' Code: ' +code + ' Name: ' + name);
      });
    }

    function startGame() {
      socket.emit('startGame', { roomCode }, (res) => {
        if (res.error) return log('âŒ ' + res.error);
        log('â–¶ï¸ Game started!');
      });
    }

    
    function selectQuestion() {
      console.log('Select Question button clicked'); // Debugging log
      const questionIndex = prompt('Enter question index (0, 1, 2, ...):');
     
      if (questionIndex === null || questionIndex === '') {
        console.log('No question index entered'); // Debugging log
        return;
      }
      console.log('Room Code:', roomCode);
      console.log('Question Index:', questionIndex);

  
      socket.emit('selectQuestion', { roomCode, questionIndex: parseInt(questionIndex) }, (res) => {
        if (res.error) {
          log('âŒ ' + res.error);
          return;
        }
        log('âœ… Question selected: ' + questionIndex);
      });
    }

    socket.on('questionSelected', (data) => {
      if (data.buzzOpen) {
        log('ðŸ”” Buzzing is OPEN');
      } else {
        log('ðŸ”• Buzzing is CLOSED');
      }
    });

    function buzzIn() {
      socket.emit('buzzIn', { roomCode, playerId }, (res) => {
        if (res.error) return log('âŒ ' + res.error);
        log('ðŸ”” Buzzed in!');
      });
    }

   
    function awardPoints() {
      console.log('Award Points button clicked'); // Debugging log
      const points = parseInt(document.getElementById('pointsToAward').value);
      if (isNaN(points)) return log('âŒ Invalid point value');
      socket.emit('awardPoints', { roomCode, playerId, points }, (res) => {
        console.log('Server response:', res);
        if (res.error) return log('âŒ ' + res.error);
        log('ðŸ… Awarded ' + points + ' points!');
      });
    }

    function simulateDisconnect() {
      socket.disconnect();
      log('ðŸ”Œ Disconnected from server');
    }

    // ðŸ”” Server events
    socket.on('questionSelected', (data) => log('â“ Question selected: ' + JSON.stringify(data.question)));
    socket.on('questionEnded', (data) => log('â° Question ended: ' + data.reason));
    socket.on('gameOver', (data) => log('ðŸ Game over! Winner: ' + data.winner));
    socket.on('nextQuestion', (data) => log('âž¡ï¸ Next question: ' + data.question));
    socket.on('playerJoined', (data) => log('ðŸ‘¥ New player joined: ' + data.player.name));
    socket.on('playerBuzzed', (data) => log('ðŸŸ¡ Buzzed: ' + data.name));
    socket.on('playerAnswered', (data) => log('ðŸ—£ï¸ Answered: ' + data.player.name));
    socket.on('pointsAwarded', (data) => log('ðŸ† Points awarded: ' + data.points + ' to ' + data.player.name));
    socket.on('error', (err) => log('âŒ Error: ' + err.message));
    socket.on('connect', () => log('âœ… Connected to server'));
    socket.on('disconnect', () => log('âŒ Disconnected from server'));
    socket.on('reconnect_attempt', () => log('ðŸ”„ Attempting to reconnect...'));
    socket.on('reconnect', (attempt) => log('âœ… Reconnected after ' + attempt + ' attempts'));
    socket.on('reconnect_error', (err) => log('âŒ Reconnect error: ' + err.message));
    socket.on('reconnect_failed', () => log('âŒ Reconnect failed'));
    socket.on('questionSelected', (data) => {log(`âž¡ï¸ Question Selected`)});
    socket.on('gameStateUpdate', (gameState) => {log('ðŸ“Š Game state updated: ' + JSON.stringify(gameState));});





    // Optional reconnect logic
    socket.on('disconnect', () => log('âŒ Disconnected'));
    socket.on('connect', () => log('âœ… Reconnected'));
  </script>
</body>
</html>
